<!doctype html><html class=""><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=2, initial-scale=1, user-scalable=yes"><link rel="icon" href="data:;base64,="><link rel="stylesheet" type="text/css" href="/styles/main.css"><title>Shorten your Go code by using exceptions</title><link rel="alternate" type="application/atom+xml" title="Mitranim's Posts (Atom)" href="/feed.xml"><link rel="alternate" type="application/rss+xml" title="Mitranim's Posts (RSS)" href="/feed_rss.xml"><meta name="author" content="Nelo Mitranim"><meta property="og:title" content="Shorten your Go code by using exceptions"><meta name="description" content="Go secretly favors exceptions. Use them."><meta name="og:description" content="Go secretly favors exceptions. Use them."><meta property="og:site_name" content="about:mitranim"></head><body id="top"><header class="header"><nav class="flex row-sta-str"><a class="header-link --busy" href="/">home</a><a class="header-link --busy" href="/works">works</a><a class="header-link --busy" href="/posts">posts</a><a class="header-link --busy" href="/games">games</a></nav><span class="flex-1"></span><span class="header-update" aria-label="last update anywhere on the site">updated: 2025-Feb-24</span></header><article role="main" id="main" class="main article"><h1 class="heading-prefix">Shorten your Go code by using exceptions</h1><p class="post-desc">Go secretly favors exceptions. Use them.</p><p class="post-time">written 2021-Nov-20, updated 2023-Oct-31</p><p>This post is informed by many years of Go, and months of Go with exceptions. <strong>I am well aware</strong> of many arguments for error values. Some of them are addressed below.</p>

<p>Reddit discussion: <a href="https://www.reddit.com/r/golang/comments/r2h31i/shorten_your_go_code_by_using_exceptions/" target="_blank" rel="noopener noreferrer">https://www.reddit.com/r/golang/comments/r2h31i/shorten_your_go_code_by_using_exceptions/<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; width: 1.5ex; height: 1.5ex; margin-left: 0.3ch;" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg></a></p>

<p><strong>Update 2023-10-23.</strong> The original version of this post referred to <a href="https://github.com/mitranim/try" target="_blank" rel="noopener noreferrer">https://github.com/mitranim/try<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; width: 1.5ex; height: 1.5ex; margin-left: 0.3ch;" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg></a>. The updated post refers to <a href="https://github.com/mitranim/gg" target="_blank" rel="noopener noreferrer">https://github.com/mitranim/gg<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; width: 1.5ex; height: 1.5ex; margin-left: 0.3ch;" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg></a>, which subsumes the previous library and offers more features.</p>

<ul>
<li><a href="#myths-to-debunk"><span class="hash-prefix" aria-hidden="true">#</span>Myths to debunk</a></li>
<li><a href="#observations"><span class="hash-prefix" aria-hidden="true">#</span>Observations</a></li>
<li><a href="#performance"><span class="hash-prefix" aria-hidden="true">#</span>Performance</a></li>
<li><a href="#stack-traces"><span class="hash-prefix" aria-hidden="true">#</span>Stack traces</a></li>
</ul>
<h2 id="myths-to-debunk" class="heading-prefix">Myths to debunk<a href="#myths-to-debunk" class="heading-anchor" aria-hidden="true"></a></h2><blockquote class="blockquote">
<p>&quot;Go doesn't have exceptions&quot;.</p>
</blockquote>
<p>Go has panics, which are exceptions.</p>
<blockquote class="blockquote">
<p>&quot;Errors-as-values is simpler than exceptions&quot;.</p>
</blockquote>
<p>Decent argument that doesn't apply to Go. Go already has both. We don't get to choose to use just one.</p>
<blockquote class="blockquote">
<p>&quot;All errors are in function signatures&quot;.</p>
</blockquote>
<p>The stdlib has many documented panics. New releases frequently add more. Panics are not in function signatures.</p>
<blockquote class="blockquote">
<p>&quot;Panics are reserved for unrecoverable errors&quot;.</p>
</blockquote>
<p>Untrue in Go. Panics are recoverable and actionable. For example, HTTP servers respond with 500 and error details instead of crashing.</p>
<blockquote class="blockquote">
<p>&quot;Explicit errors lead to more reliable code.&quot;</p>
</blockquote>
<p>Decent argument that doesn't apply to Go. Go has panics. Reliable code <em>must</em> handle panics in addition to error values. Code that assumes &quot;no panics&quot; or &quot;panics always crash the process&quot; will have leaks, data corruption, and other unexpected states.</p>
<blockquote class="blockquote">
<p>&quot;Panics are expensive&quot;.</p>
</blockquote>
<p>Panics are cheap. Stack traces have a minor cost.</p>
<h2 id="observations" class="heading-prefix">Observations<a href="#observations" class="heading-anchor" aria-hidden="true"></a></h2>
<ul>
<li>&quot;Just panics&quot; is objectively simpler than &quot;error values and panics&quot;. 1 is objectively less than 2.</li>
<li>&quot;Just panics&quot; is more reliable than &quot;error values and panics&quot;. You only need to handle 1, not 2.</li>
<li>Requires some un-doctrination, after years of trying to believe in error values.</li>
<li>Performance is nearly the same.</li>
<li>Avoids mishandling of <code>err</code> variables.</li>
<li>Exceptions and stack traces are orthogonal. You want both.</li>
</ul>

<p>Combination of <code>defer</code> <code>panic</code> <code>recover</code> allows terse and flexible exception handling.</p>

<p>Brevity:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822"><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;github.com/mitranim/gg&#34;</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">outer</span>() {
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">gg</span>.<span style="color:#a6e22e">Detail</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">failed to do X</span><span style="color:#e6db74">`</span>)
  <span style="color:#a6e22e">someFunc</span>()
  <span style="color:#a6e22e">anotherFunc</span>()
  <span style="color:#a6e22e">moreFunc</span>()
}
</pre>
<p>Same without panics:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">outer</span>() (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ErrWrapf</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">err</span>, <span style="color:#e6db74">`</span><span style="color:#e6db74">failed to do X</span><span style="color:#e6db74">`</span>)

  <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">someFunc</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span>
  }

  <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">anotherFunc</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span>
  }

  <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">moreFunc</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span>
  }

  <span style="color:#66d9ef">return</span>
}

<span style="color:#75715e">// Suboptimal implementation, only for example purposes.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ErrWrapf</span>(<span style="color:#a6e22e">out</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">pat</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">msg</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">any</span>) {
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">out</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">out</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#f92672">*</span><span style="color:#a6e22e">out</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#a6e22e">pat</span>, <span style="color:#a6e22e">msg</span><span style="color:#f92672">...</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">`</span><span style="color:#e6db74">: %w</span><span style="color:#e6db74">`</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">out</span>)
  }
}
</pre><h2 id="performance" class="heading-prefix">Performance<a href="#performance" class="heading-anchor" aria-hidden="true"></a></h2>
<p>In modern Go (1.17 and higher), there is barely any difference. Defer/panic/recover is usable even in CPU-heavy hotspot code.</p>

<p>Generating stack traces has a far larger cost. The examples in this post use <code>github.com/mitranim/gg</code> which automatically adds stack traces. If you're using stack traces with error values, that cost is already dominant, compared to the cost of defer/panic/recover.</p>
<h2 id="stack-traces" class="heading-prefix">Stack traces<a href="#stack-traces" class="heading-anchor" aria-hidden="true"></a></h2>
<p>Stack traces are essential to debugging, with or without exceptions.</p>

<ul>
<li>Exceptions and stack traces are orthogonal.</li>
<li>Exceptions don't require stack traces.</li>
<li>You <em>always</em> want stack traces for debugging.

<ul>
<li>Many languages elide them for performance, but you still want them.</li>
<li>Don't show stack traces to your users. They should be printed only in debug logging.</li>
</ul></li>
<li>Lack of stack traces causes developers to <em>manually emulate stack traces</em>.</li>
</ul>

<p>Some real Go code, written by experienced developers, has errors annotated with function names, like this:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">someFunc</span>() <span style="color:#66d9ef">error</span> {
  <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">anotherFunc</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">someFunc: anotherFunc: %w</span><span style="color:#e6db74">`</span>, <span style="color:#a6e22e">err</span>)
  }

  <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">moreFunc</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">someFunc: moreFunc: %w</span><span style="color:#e6db74">`</span>, <span style="color:#a6e22e">err</span>)
  }

  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</pre>
<p>You can simplify this with <code>defer</code>, as shown above:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">someFunc</span>() (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ErrWrapf</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">err</span>, <span style="color:#e6db74">`</span><span style="color:#e6db74">someFunc</span><span style="color:#e6db74">`</span>)

  <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">anotherFunc</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span>
  }

  <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">moreFunc</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span>
  }

  <span style="color:#66d9ef">return</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">anotherFunc</span>() (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ErrWrapf</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">err</span>, <span style="color:#e6db74">`</span><span style="color:#e6db74">anotherFunc</span><span style="color:#e6db74">`</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">someErroringOperation</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">moreFunc</span>() (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ErrWrapf</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">err</span>, <span style="color:#e6db74">`</span><span style="color:#e6db74">moreFunc</span><span style="color:#e6db74">`</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">anotherErroringOperation</span>()
}

<span style="color:#75715e">// Suboptimal implementation, only for example purposes.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ErrWrapf</span>(<span style="color:#a6e22e">out</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">pat</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">msg</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">any</span>) {
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">out</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">out</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#f92672">*</span><span style="color:#a6e22e">out</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#a6e22e">pat</span>, <span style="color:#a6e22e">msg</span><span style="color:#f92672">...</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">`</span><span style="color:#e6db74">: %w</span><span style="color:#e6db74">`</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">out</span>)
  }
}
</pre>
<p>🔔 Alarm bells should be ringing in your head. This emulates a stack trace, doing manually what other languages have automated decades ago.</p>

<p>So stop doing that. Automate your stack traces, and shorten your code:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822"><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;github.com/mitranim/gg&#34;</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">someFunc</span>() {
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">gg</span>.<span style="color:#a6e22e">Detail</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">failed to do X</span><span style="color:#e6db74">`</span>)
  <span style="color:#a6e22e">anotherFunc</span>()
  <span style="color:#a6e22e">moreFunc</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">anotherFunc</span>() {
  <span style="color:#a6e22e">gg</span>.<span style="color:#a6e22e">Try</span>(<span style="color:#a6e22e">someErroringOperation</span>())
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">moreFunc</span>() {
  <span style="color:#a6e22e">gg</span>.<span style="color:#a6e22e">Try</span>(<span style="color:#a6e22e">anothrErroringOperation</span>())
}
</pre></article><hr class="hr mar-ver-1 pad-hor-body"><p class="pad-hor-body">This blog currently doesn't support comments. Write to me via <a href="/#contacts" class="link-deco">contacts</a>.</p><p class="feed-links pad-hor-body"><span>Subscribe using one of:</span><a href="/feed.xml" class="link-deco" target="_blank" rel="noopener noreferrer">Atom<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; width: 1.5ex; height: 1.5ex; margin-left: 0.3ch;" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg></a><a href="/feed_rss.xml" class="link-deco" target="_blank" rel="noopener noreferrer">RSS<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; width: 1.5ex; height: 1.5ex; margin-left: 0.3ch;" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg></a><a href="https://feedly.com/i/subscription/feed/https://mitranim.com/feed.xml" class="link-deco" target="_blank" rel="noopener noreferrer">Feedly<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; width: 1.5ex; height: 1.5ex; margin-left: 0.3ch;" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg></a></p><footer class="footer"><span class="flex-1 flex row-sta-cen gap-hor-0x5 pad-lef-body"><span class="text-lef">2014-2025</span><a href="https://github.com/mitranim/mitranim.github.io" class="link-deco wspace-nowrap" target="_blank" rel="noopener noreferrer">code<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; width: 1.5ex; height: 1.5ex; margin-left: 0.3ch;" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg></a></span><span class="flex-1 text-cen"><a href="/#contacts" class="link-deco">touch me</a></span><span class="flex-1 flex row-end-cen"><a href="#top" class="fill-gray-fg-near pad-body busy-gray-bg" onclick="event.preventDefault(); window.scrollTo(0, 0)"><svg class="svg-icon fill-fg" viewBox="0 0 448 512" width="1em" height="1em"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></span></footer></body></html>